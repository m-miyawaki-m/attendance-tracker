# `logger.ts` 単体テスト仕様書

## 1. 概要

| 項目 | 内容 |
|:---|:---|
| 対象ファイル | `src/utils/logger.ts` |
| 関連設計書 | - |
| 設計書記載 | ユーティリティモジュール（ログのLocalStorage保存、取得、削除、ダウンロード機能） |

## 2. テストの目的

`logger.ts`モジュールが、ログのLocalStorage保存、取得、削除、ダウンロード機能を正しく実装していることを保証する。

## 3. 使用するライブラリ

* **テストランナー**: Vitest
* **モック**: localStorage、console、URL.createObjectURL

## 4. テストケース

### 4.1. getLogs 関数

| テストNo. | テストケース | LocalStorage状態 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 1-1 | ログあり | 有効なJSON配列 | LogEntry配列を返す。 |
| 1-2 | ログなし | nullまたは空 | 空配列を返す。 |
| 1-3 | 不正なJSON | パースエラー | 空配列を返す。 |

### 4.2. saveLogs 関数（内部）

| テストNo. | テストケース | 条件 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 2-1 | 通常保存 | サイズ制限内 | LocalStorageに保存される。 |
| 2-2 | サイズ超過 | 4MBを超える | 古いログを削除して再保存される。 |
| 2-3 | LocalStorageエラー | 例外発生 | エラーが無視される（console.warnのみ）。 |

### 4.3. addLogEntry 関数（内部）

| テストNo. | テストケース | 入力 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 3-1 | 基本ログ追加 | `('info', 'メッセージ')` | ・timestamp、level、messageが設定される。<br>・ログが末尾に追加される。 |
| 3-2 | データ付きログ追加 | `('debug', 'メッセージ', { key: 'value' })` | dataプロパティも設定される。 |
| 3-3 | 最大件数超過 | 1000件超過 | 古いログが削除され、最新1000件が保持される。 |
| 3-4 | リスナー通知 | ログ追加時 | 登録されたリスナーが呼び出される。 |

### 4.4. clearLogs 関数

| テストNo. | テストケース | 期待する結果 |
| :--- | :--- | :--- |
| 4-1 | ログクリア | LocalStorageからキーが削除される。 |
| 4-2 | LocalStorageエラー | 例外が無視される。 |

### 4.5. formatLogsAsText 関数

| テストNo. | テストケース | 入力 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 5-1 | テキストフォーマット | LogEntry配列 | `'[timestamp] [LEVEL] message | data'`形式の文字列。 |
| 5-2 | dataなし | `data: undefined` | `'[timestamp] [LEVEL] message'`形式。 |
| 5-3 | 複数ログ | 3件のログ | 改行区切りで連結される。 |

### 4.6. downloadLogsAsJson 関数

| テストNo. | テストケース | 期待する結果 |
| :--- | :--- | :--- |
| 6-1 | JSONダウンロード | ・Blobが`application/json`タイプで作成される。<br>・ファイル名が`app-logs-{timestamp}.json`形式。<br>・ダウンロードが開始される。 |

### 4.7. downloadLogsAsText 関数

| テストNo. | テストケース | 期待する結果 |
| :--- | :--- | :--- |
| 7-1 | テキストダウンロード | ・Blobが`text/plain`タイプで作成される。<br>・ファイル名が`app-logs-{timestamp}.txt`形式。<br>・ダウンロードが開始される。 |

### 4.8. getLogCount 関数

| テストNo. | テストケース | ログ件数 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 8-1 | 件数取得 | 50件 | `50`を返す。 |
| 8-2 | 空の場合 | 0件 | `0`を返す。 |

### 4.9. getLogSize 関数

| テストNo. | テストケース | LocalStorage状態 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 9-1 | サイズ取得 | データあり | バイト数を返す。 |
| 9-2 | 空の場合 | データなし | `0`を返す。 |
| 9-3 | LocalStorageエラー | 例外発生 | `0`を返す。 |

### 4.10. onLogUpdate / notifyLogUpdate

| テストNo. | テストケース | 操作 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 10-1 | リスナー登録 | `onLogUpdate(callback)` | リスナーが登録され、unsubscribe関数が返される。 |
| 10-2 | リスナー通知 | ログ追加時 | 全てのリスナーが呼び出される。 |
| 10-3 | リスナー解除 | unsubscribe()呼び出し | 以降のログ追加でリスナーが呼び出されない。 |

### 4.11. logger オブジェクト

#### 4.11.1. debug メソッド

| テストNo. | テストケース | `import.meta.env.DEV` | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 11-1-1 | 開発環境 | `true` | ・LocalStorageに保存される。<br>・`console.debug`が呼び出される。 |
| 11-1-2 | 本番環境 | `false` | ・LocalStorageに保存される。<br>・`console.debug`が呼び出されない。 |

#### 4.11.2. info メソッド

| テストNo. | テストケース | 期待する結果 |
| :--- | :--- | :--- |
| 11-2-1 | infoログ | ・LocalStorageに保存される。<br>・`console.info`が呼び出される。 |

#### 4.11.3. warn メソッド

| テストNo. | テストケース | 期待する結果 |
| :--- | :--- | :--- |
| 11-3-1 | warnログ | ・LocalStorageに保存される。<br>・`console.warn`が呼び出される。 |

#### 4.11.4. error メソッド

| テストNo. | テストケース | 期待する結果 |
| :--- | :--- | :--- |
| 11-4-1 | errorログ | ・LocalStorageに保存される。<br>・`console.error`が呼び出される。 |

#### 4.11.5. log メソッド

| テストNo. | テストケース | 期待する結果 |
| :--- | :--- | :--- |
| 11-5-1 | logメソッド | `info`メソッドが呼び出される。 |
