# Phase 2 テスト実装ロードマップ

## 概要

Phase 2では、中優先度のテスト実装を行う。以下の5つの主要な実装を完了する。

| No | 対象 | タイプ | 推定テスト数 |
|----|------|--------|--------------|
| 1 | LoginView.vue | コンポーネント | 15 |
| 2 | userStore.ts | ストア | 26 |
| 3 | TeamView.vue | コンポーネント | 29 |
| 4 | EmployeeListView.vue | コンポーネント | 17 |
| 5 | useLogger.ts | Composable | 25 |

---

## 1. LoginView.vue テスト実装

### 1.1 概要
ログイン画面のUIテスト。現在1テストのみ存在するため、テストを拡充する。

### 1.2 テストケース

#### 1.2.1 初期表示テスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 1 | LV-001 | フォーム要素表示 | メールアドレス入力欄、パスワード入力欄、ログインボタンが表示される |
| 2 | LV-002 | テストアカウントチップ表示 | 管理者、user01、user02、user03のテストアカウントチップが表示される |
| 3 | LV-003 | 初期値 | メールアドレス・パスワード欄が空、`rememberMe`がfalse |

#### 1.2.2 テストアカウント入力テスト
| No | テストID | テストケース | 操作 | 期待結果 |
|----|----------|--------------|------|----------|
| 4 | LV-004 | 管理者アカウント選択 | 管理者チップをクリック | `email`が`'admin@example.com'`、`password`が`'adminadmin'`に設定される |
| 5 | LV-005 | user01アカウント選択 | user01チップをクリック | `email`が`'user01@example.com'`、`password`が`'user01'`に設定される |
| 6 | LV-006 | user02アカウント選択 | user02チップをクリック | `email`が`'user02@example.com'`、`password`が`'password123'`に設定される |

#### 1.2.3 ログイン処理テスト
| No | テストID | テストケース | ストアの動作 | 期待結果 |
|----|----------|--------------|--------------|----------|
| 7 | LV-007 | ログイン成功（一般ユーザー） | `login`成功、`isAdmin`=false | `router.push('/')`が呼び出される |
| 8 | LV-008 | ログイン成功（管理者） | `login`成功、`isAdmin`=true | `router.push('/admin/dashboard')`が呼び出される |
| 9 | LV-009 | ログイン失敗（認証エラー） | `login`がfalseを返す | エラースナックバーが表示される |
| 10 | LV-010 | ログイン失敗（例外） | `login`が例外をスロー | エラースナックバーが表示される |
| 11 | LV-011 | ローディング状態 | ログイン処理中 | `loading`がtrueになり、完了後falseに戻る |

#### 1.2.4 パスワードリセットテスト
| No | テストID | テストケース | 操作 | 期待結果 |
|----|----------|--------------|------|----------|
| 12 | LV-012 | パスワードリセットボタン | 「パスワードをお忘れの方」をクリック | infoスナックバーが表示される |

#### 1.2.5 スナックバー表示テスト
| No | テストID | テストケース | 引数 | 期待結果 |
|----|----------|--------------|------|----------|
| 13 | LV-013 | 成功メッセージ | `('ログインしました', 'success')` | 緑色のスナックバーが表示される |
| 14 | LV-014 | エラーメッセージ | `('エラー', 'error')` | 赤色のスナックバーが表示される |
| 15 | LV-015 | 情報メッセージ | `('情報', 'info')` | 青色のスナックバーが表示される |

### 1.3 モック要件
- `useAuthFirebaseStore` のモック
- `vue-router` のモック（useRouter）

### 1.4 作成ファイル
```
tests/unit/views/LoginView.spec.ts (既存ファイル拡充)
```

---

## 2. userStore.ts テスト実装

### 2.1 概要
Firestoreからのユーザーデータ取得、キャッシュ管理、フィルタリング機能を行うストアテスト。

### 2.2 テストケース

#### 2.2.1 State初期値テスト
| No | テストID | テストケース | State | 期待結果 |
|----|----------|--------------|-------|----------|
| 1 | US-001 | users初期値 | `users` | 空配列 `[]` |
| 2 | US-002 | loading初期値 | `loading` | `false` |
| 3 | US-003 | lastFetched初期値 | `lastFetched` | `null` |
| 4 | US-004 | error初期値 | `error` | `null` |

#### 2.2.2 Getters テスト
| No | テストID | テストケース | usersデータ | 期待結果 |
|----|----------|--------------|-------------|----------|
| 5 | US-005 | employees - 従業員フィルタリング | admin1人、employee3人 | employee3人のみ返される |
| 6 | US-006 | employees - 従業員なし | adminのみ | 空配列が返される |
| 7 | US-007 | admins - 管理者フィルタリング | admin1人、employee3人 | admin1人のみ返される |
| 8 | US-008 | managers - 主任フィルタリング | position='主任'が2人 | 主任2人のみ返される |
| 9 | US-009 | managers - 主任なし | 主任なし | 空配列が返される |
| 10 | US-010 | managers - adminの主任除外 | admin(主任)、employee(主任) | employeeの主任のみ返される |
| 11 | US-011 | usersByDepartment - 部署グループ化 | 営業部2人、開発部3人 | Map { '営業部' => [2人], '開発部' => [3人] } |
| 12 | US-012 | usersByDepartment - 空データ | users空 | 空のMap |

#### 2.2.3 fetchUsers アクション テスト
| No | テストID | テストケース | 条件 | 期待結果 |
|----|----------|--------------|------|----------|
| 13 | US-013 | 初回取得成功 | キャッシュなし | `users`にデータが設定される |
| 14 | US-014 | キャッシュ利用 | 5分以内にfetch済み | `getDocs`が呼び出されない |
| 15 | US-015 | キャッシュ期限切れ | 5分以上経過 | `getDocs`が呼び出される |
| 16 | US-016 | 強制リフレッシュ | `forceRefresh: true` | キャッシュに関係なく`getDocs`が呼び出される |
| 17 | US-017 | Firestoreエラー | `getDocs`が例外 | `error`にエラーメッセージが設定される |
| 18 | US-018 | loading状態 | - | 取得中は`loading`がtrue、完了後false |
| 19 | US-019 | データマッピング | - | 全フィールドが正しくマッピングされる |
| 20 | US-020 | Timestamp変換 | - | `createdAt`、`updatedAt`がDateに変換される |

#### 2.2.4 getUserById アクション テスト
| No | テストID | テストケース | 条件 | 期待結果 |
|----|----------|--------------|------|----------|
| 21 | US-021 | ユーザー存在 | 該当userIdあり | Userオブジェクトを返す |
| 22 | US-022 | ユーザー不在 | 該当userIdなし | `undefined`を返す |

#### 2.2.5 getTeamMembers アクション テスト
| No | テストID | テストケース | 条件 | 期待結果 |
|----|----------|--------------|------|----------|
| 23 | US-023 | チームメンバー取得 | `managerId`一致するemployeeあり | 該当employeeの配列を返す |
| 24 | US-024 | チームメンバーなし | `managerId`一致なし | 空配列を返す |
| 25 | US-025 | adminは除外 | admin(managerId一致) | 含まれない |

#### 2.2.6 clearCache アクション テスト
| No | テストID | テストケース | 初期状態 | 期待結果 |
|----|----------|--------------|----------|----------|
| 26 | US-026 | キャッシュクリア | データあり | `users`が空配列、`lastFetched`がnullになる |

### 2.3 モック要件
- Firebase Firestore のモック（collection, getDocs）
- Timestamp のモック

### 2.4 作成ファイル
```
tests/unit/stores/userStore.spec.ts
```

---

## 3. TeamView.vue テスト実装

### 3.1 概要
チーム勤怠管理画面のUIテスト。主任選択に基づくチームメンバーの勤怠一覧表示をテストする。

### 3.2 テストケース

#### 3.2.1 初期表示テスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 1 | TV-001 | タイトル表示 | 「チーム勤怠管理」が表示される |
| 2 | TV-002 | 日付初期値 | 今日の日付がデフォルト値として設定される |
| 3 | TV-003 | 主任未選択時 | 「主任を選択してください」メッセージが表示される |
| 4 | TV-004 | 主任セレクト | 主任リストがドロップダウンに表示される |

#### 3.2.2 初期データ取得テスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 5 | TV-005 | ユーザー取得 | `userStore.fetchUsers()`が呼び出される |
| 6 | TV-006 | 勤怠取得 | `attendanceStore.fetchAttendancesByDate(selectedDate)`が呼び出される |
| 7 | TV-007 | 並列実行 | 両方のfetchが`Promise.all`で並列実行される |
| 8 | TV-008 | エラーハンドリング | 取得失敗時、loggerにエラーが記録される |

#### 3.2.3 日付変更テスト
| No | テストID | テストケース | 操作 | 期待結果 |
|----|----------|--------------|------|----------|
| 9 | TV-009 | 日付変更時の再取得 | 日付を変更 | `attendanceStore.fetchAttendancesByDate(newDate)`が呼び出される |
| 10 | TV-010 | ログ出力 | 日付変更 | loggerに日付変更が記録される |

#### 3.2.4 主任選択テスト
| No | テストID | テストケース | 操作 | 期待結果 |
|----|----------|--------------|------|----------|
| 11 | TV-011 | 主任選択時のログ | 主任を選択 | loggerに主任選択が記録される |
| 12 | TV-012 | 主任選択解除 | 選択をクリア | loggerに「主任選択解除」が記録される |

#### 3.2.5 主任リストテスト
| No | テストID | テストケース | 入力データ | 期待結果 |
|----|----------|--------------|------------|----------|
| 13 | TV-013 | 主任フィルタリング | `position: '主任'`の従業員 | 主任のみがリストに表示される |
| 14 | TV-014 | ラベル形式 | 主任データ | `'名前 (部署 - 社員番号)'`形式でラベルが設定される |

#### 3.2.6 選択主任名テスト
| No | テストID | テストケース | 条件 | 期待結果 |
|----|----------|--------------|------|----------|
| 15 | TV-015 | 主任未選択 | `selectedManagerId`がnull | 空文字列が返される |
| 16 | TV-016 | 主任選択済み | `selectedManagerId`が設定済み | 主任の名前が返される |

#### 3.2.7 チーム勤怠リストテスト
| No | テストID | テストケース | 条件 | 期待結果 |
|----|----------|--------------|------|----------|
| 17 | TV-017 | 主任未選択 | `selectedManagerId`がnull | 空配列が返される |
| 18 | TV-018 | チームメンバー取得 | 主任選択済み | `userStore.getTeamMembers(managerId)`でメンバーが取得される |
| 19 | TV-019 | 勤怠データマッピング | メンバーに勤怠あり | 勤怠データがマッピングされる |
| 20 | TV-020 | 勤怠データなし | メンバーに勤怠なし | `status: 'absent'`が設定される |
| 21 | TV-021 | 勤務時間計算 | `workingMinutes: 540` | `'9:00'`形式で表示される |
| 22 | TV-022 | 勤務時間なし | `workingMinutes`がundefined | `'-'`が表示される |

#### 3.2.8 チームサマリーテスト
| No | テストID | テストケース | 入力データ | 期待結果 |
|----|----------|--------------|------------|----------|
| 23 | TV-023 | 総メンバー数 | チームリスト | `totalMembers`にチームメンバー数が設定される |
| 24 | TV-024 | 正常出勤数 | `status: 'present'`の件数 | `present`に正しい値が設定される |
| 25 | TV-025 | 遅刻・早退数 | `status: 'late'`と`'early_leave'`の件数 | `lateEarly`に合計値が設定される |
| 26 | TV-026 | 欠勤数 | `status: 'absent'`の件数 | `absent`に正しい値が設定される |

#### 3.2.9 サマリーカード表示テスト
| No | テストID | テストケース | 条件 | 期待結果 |
|----|----------|--------------|------|----------|
| 27 | TV-027 | 主任選択時 | `selectedManagerId`が設定済み | 4つのサマリーカードが表示される |
| 28 | TV-028 | 主任未選択時 | `selectedManagerId`がnull | サマリーカードが表示されない |

#### 3.2.10 ヘルパー関数テスト
| No | テストID | テストケース | 入力 | 期待結果 |
|----|----------|--------------|------|----------|
| 29 | TV-029 | formatTime | `new Date('2026-01-05T09:30:00')` | `'09:30'`が返される |

### 3.3 モック要件
- `useUserStore` のモック
- `useAttendanceFirebaseStore` のモック
- `useLogger` のモック

### 3.4 作成ファイル
```
tests/unit/views/admin/TeamView.spec.ts
```

---

## 4. EmployeeListView.vue テスト実装

### 4.1 概要
従業員管理画面のUIテスト。従業員一覧と月次勤怠集計を表示する。

### 4.2 テストケース

#### 4.2.1 初期表示テスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 1 | EL-001 | 月選択フィールド | 現在の年月が初期値として設定される（`YYYY-MM`形式） |
| 2 | EL-002 | ヘッダー表示 | 「従業員管理」タイトルが表示される |
| 3 | EL-003 | テーブルヘッダー | 社員番号、名前、役職、当月の出勤ステータス、備考のカラムが表示される |

#### 4.2.2 データ取得テスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 4 | EL-004 | ユーザー取得 | マウント時に`users`コレクションからデータが取得される |
| 5 | EL-005 | 勤怠取得 | 選択月の開始日〜終了日で勤怠データが取得される |
| 6 | EL-006 | ローディング状態 | データ取得中は`loading`がtrue、完了後falseになる |

#### 4.2.3 月選択変更テスト
| No | テストID | テストケース | 操作 | 期待結果 |
|----|----------|--------------|------|----------|
| 7 | EL-007 | 月変更時の再取得 | 月選択を変更 | `fetchAttendances`が呼び出され、新しい月のデータが取得される |
| 8 | EL-008 | 日付範囲計算 | 2026-01を選択 | `startDate: '2026-01-01'`、`endDate: '2026-01-31'`でクエリされる |

#### 4.2.4 従業員リスト計算テスト
| No | テストID | テストケース | 入力データ | 期待結果 |
|----|----------|--------------|------------|----------|
| 9 | EL-009 | 従業員フィルタリング | `role: 'employee'`のみ | `role: 'admin'`のユーザーは除外される |
| 10 | EL-010 | 勤怠ステータス集計 | ユーザーの月間勤怠 | `attendanceStatus`オブジェクトに各ステータスの件数が設定される |
| 11 | EL-011 | ステータス初期値 | 勤怠データなし | `{ present: 0, late: 0, early_leave: 0, absent: 0 }`が設定される |
| 12 | EL-012 | 社員番号表示 | `employeeNumber`がundefined | `'-'`が表示される |

#### 4.2.5 テーブル表示テスト
| No | テストID | テストケース | データ | 期待結果 |
|----|----------|--------------|--------|----------|
| 13 | EL-013 | 社員番号 | `employeeNumber: 'EMP001'` | `'EMP001'`が表示される |
| 14 | EL-014 | 名前 | `name: '山田太郎'` | `'山田太郎'`が表示される |
| 15 | EL-015 | 役職 | `position: '主任'` | `'主任'`が表示される |

#### 4.2.6 ページネーションテスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 16 | EL-016 | デフォルト表示件数 | 1ページあたり10件が表示される |
| 17 | EL-017 | ページ切り替え | ページネーションが機能する |

### 4.3 モック要件
- `useUserStore` のモック
- `useAttendanceFirebaseStore` のモック
- Firebase Firestore のモック

### 4.4 作成ファイル
```
tests/unit/views/admin/EmployeeListView.spec.ts
```

---

## 5. useLogger.ts テスト実装

### 5.1 概要
ログ機能をVueコンポーネントで利用しやすい形で提供するComposableテスト。

### 5.2 テストケース

#### 5.2.1 初期化テスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 1 | UL-001 | 初期ログ読み込み | `logs`に`getLogs()`の結果が設定される |
| 2 | UL-002 | リスナー登録 | `onLogUpdate`でリスナーが登録される |

#### 5.2.2 State テスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 3 | UL-003 | logs | ref型でLogEntry配列を保持する |
| 4 | UL-004 | isLoading | ref型でboolean値を保持する（初期値false） |

#### 5.2.3 refreshLogs 関数テスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 5 | UL-005 | ログ再読み込み | `logs.value`が`getLogs()`の結果で更新される |

#### 5.2.4 logCount computed テスト
| No | テストID | テストケース | logsデータ | 期待結果 |
|----|----------|--------------|------------|----------|
| 6 | UL-006 | 件数取得 | 50件 | `50`を返す |
| 7 | UL-007 | 空の場合 | 0件 | `0`を返す |
| 8 | UL-008 | リアクティブ更新 | ログ追加時 | 自動的に更新される |

#### 5.2.5 logSizeFormatted computed テスト
| No | テストID | テストケース | サイズ | 期待結果 |
|----|----------|--------------|--------|----------|
| 9 | UL-009 | バイト表示 | 500B | `'500 B'` |
| 10 | UL-010 | KB表示 | 2048B | `'2.0 KB'` |
| 11 | UL-011 | MB表示 | 2MB | `'2.0 MB'` |
| 12 | UL-012 | リアクティブ更新 | ログ追加時 | 自動的に更新される |

#### 5.2.6 clear 関数テスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 13 | UL-013 | クリア実行 | `clearLogs()`が呼び出され、`logs.value`が空配列になる |

#### 5.2.7 downloadJson 関数テスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 14 | UL-014 | JSONダウンロード | `downloadLogsAsJson()`が呼び出される |

#### 5.2.8 downloadText 関数テスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 15 | UL-015 | テキストダウンロード | `downloadLogsAsText()`が呼び出される |

#### 5.2.9 filterByLevel 関数テスト
| No | テストID | テストケース | level引数 | 期待結果 |
|----|----------|--------------|-----------|----------|
| 16 | UL-016 | 全て | `'all'` | 全ログを返す |
| 17 | UL-017 | errorのみ | `'error'` | `level: 'error'`のログのみ返す |
| 18 | UL-018 | infoのみ | `'info'` | `level: 'info'`のログのみ返す |

#### 5.2.10 searchLogs 関数テスト
| No | テストID | テストケース | keyword引数 | 期待結果 |
|----|----------|--------------|-------------|----------|
| 19 | UL-019 | 空文字 | `''` | 全ログを返す |
| 20 | UL-020 | メッセージ検索 | `'login'` | messageに`'login'`を含むログを返す |
| 21 | UL-021 | データ検索 | `'userId'` | dataに`'userId'`を含むログを返す |
| 22 | UL-022 | 大文字小文字無視 | `'LOGIN'` | 大文字小文字を区別せずに検索する |

#### 5.2.11 logger インスタンステスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 23 | UL-023 | エクスポート | `logger`インスタンスが返り値に含まれる |

#### 5.2.12 ライフサイクルテスト
| No | テストID | テストケース | 期待結果 |
|----|----------|--------------|----------|
| 24 | UL-024 | アンマウント時 | `onUnmounted`でリスナーが解除される |
| 25 | UL-025 | リスナー自動更新 | ログ追加時に`logs.value`が自動更新される |

### 5.3 モック要件
- `@/utils/logger` のモック

### 5.4 作成ファイル
```
tests/unit/composables/useLogger.spec.ts
```

---

## 実装順序

1. **userStore.ts** - 他のテストの前提となるユーザーストア
2. **LoginView.vue** - 認証フロー関連のUIテスト
3. **useLogger.ts** - Composableテスト（他のViewテストで利用）
4. **TeamView.vue** - チーム管理UIテスト
5. **EmployeeListView.vue** - 従業員管理UIテスト

---

## GitHub Issues

以下のIssueを作成する:

1. **#XX** - [Phase2] LoginView.vue 単体テスト拡充
2. **#XX** - [Phase2] userStore.ts 単体テスト実装
3. **#XX** - [Phase2] TeamView.vue 単体テスト実装
4. **#XX** - [Phase2] EmployeeListView.vue 単体テスト実装
5. **#XX** - [Phase2] useLogger.ts 単体テスト実装

---

## 完了条件

- [ ] 全テストケースが実装されている
- [ ] 全テストがパス（緑）している
- [ ] カバレッジが向上している
  - ストア: 50% → 65%以上
  - コンポーネント: 40% → 55%以上
  - Composable: 0% → 50%以上
- [ ] ドキュメントが更新されている
