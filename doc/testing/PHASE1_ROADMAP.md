# Phase 1 テスト実装ロードマップ

## 概要

Phase 1では、高優先度のテスト実装を行う。以下の4つの主要な実装を完了する。

| No | 対象 | タイプ | 推定テスト数 |
|----|------|--------|--------------|
| 1 | HomeView.vue | コンポーネント | 15-20 |
| 2 | authFirebase.ts | ストア | 15-20 |
| 3 | attendanceFirebase.ts | ストア | 20-25 |
| 4 | DashboardView.vue | コンポーネント | 10-15 |

---

## 1. HomeView.vue テスト実装

### 1.1 概要
打刻画面のUIテスト。一般従業員が最も頻繁に使用する画面であり、打刻機能の動作確認が必須。

### 1.2 テストケース

#### 1.2.1 表示テスト
| No | テストケース | 期待結果 |
|----|--------------|----------|
| HV-001 | 画面タイトル表示 | "打刻" タイトルが表示される |
| HV-002 | 現在時刻表示 | リアルタイムで時刻が更新される |
| HV-003 | 日付表示 | 今日の日付が表示される |
| HV-004 | ユーザー名表示 | ログインユーザー名が表示される |

#### 1.2.2 出勤打刻テスト
| No | テストケース | 前提条件 | 操作 | 期待結果 |
|----|--------------|----------|------|----------|
| HV-005 | 出勤ボタン表示 | 未出勤状態 | - | 出勤ボタンが有効 |
| HV-006 | 出勤打刻成功 | 未出勤状態 | 出勤ボタンクリック | 出勤記録が作成される |
| HV-007 | 出勤後ボタン無効化 | 出勤済み | - | 出勤ボタンが無効化 |
| HV-008 | 出勤時刻表示 | 出勤済み | - | 出勤時刻が表示される |

#### 1.2.3 退勤打刻テスト
| No | テストケース | 前提条件 | 操作 | 期待結果 |
|----|--------------|----------|------|----------|
| HV-009 | 退勤ボタン表示 | 出勤済み | - | 退勤ボタンが有効 |
| HV-010 | 退勤打刻成功 | 出勤済み | 退勤ボタンクリック | 退勤記録が追加される |
| HV-011 | 退勤後ボタン無効化 | 退勤済み | - | 両ボタンが無効化 |
| HV-012 | 勤務時間表示 | 退勤済み | - | 勤務時間が計算・表示される |

#### 1.2.4 位置情報テスト
| No | テストケース | 操作 | 期待結果 |
|----|--------------|------|----------|
| HV-013 | 位置情報取得成功 | 打刻実行 | 位置情報が記録に含まれる |
| HV-014 | 位置情報取得失敗 | 位置情報拒否で打刻 | エラーメッセージ表示 |

#### 1.2.5 エラーハンドリング
| No | テストケース | 条件 | 期待結果 |
|----|--------------|------|----------|
| HV-015 | API エラー時の表示 | 打刻API失敗 | エラーメッセージ表示 |
| HV-016 | ローディング状態 | 打刻処理中 | ローディングインジケーター表示 |

### 1.3 モック要件
- `useAttendanceFirebaseStore` のモック
- `useAuthFirebaseStore` のモック
- Geolocation API のモック
- 時刻のモック（vitest.useFakeTimers）

### 1.4 作成ファイル
```
tests/unit/views/HomeView.spec.ts
```

---

## 2. authFirebase.ts テスト実装

### 2.1 概要
Firebase Authentication連携のストアテスト。認証機能の中核であり、セキュリティ上も重要。

### 2.2 テストケース

#### 2.2.1 初期化テスト
| No | テストケース | 期待結果 |
|----|--------------|----------|
| AF-001 | 初期状態確認 | user=null, isAuthenticated=false |
| AF-002 | 認証状態リスナー設定 | onAuthStateChanged が呼ばれる |

#### 2.2.2 ログインテスト
| No | テストケース | 入力 | 期待結果 |
|----|--------------|------|----------|
| AF-003 | メール/パスワードログイン成功 | 有効な認証情報 | isAuthenticated=true |
| AF-004 | ログイン失敗（無効メール） | 存在しないメール | エラー返却 |
| AF-005 | ログイン失敗（無効パスワード） | 誤ったパスワード | エラー返却 |
| AF-006 | ログイン後のユーザー情報取得 | 成功ログイン | user オブジェクト設定 |

#### 2.2.3 ログアウトテスト
| No | テストケース | 前提条件 | 期待結果 |
|----|--------------|----------|----------|
| AF-007 | ログアウト成功 | ログイン済み | user=null, isAuthenticated=false |
| AF-008 | ログアウト後のクリーンアップ | ログイン済み | 関連状態がクリアされる |

#### 2.2.4 認証状態監視テスト
| No | テストケース | イベント | 期待結果 |
|----|--------------|----------|----------|
| AF-009 | ログイン検知 | onAuthStateChanged(user) | state更新 |
| AF-010 | ログアウト検知 | onAuthStateChanged(null) | state更新 |
| AF-011 | トークン更新 | getIdToken() | 新しいトークン取得 |

#### 2.2.5 ユーザー情報テスト
| No | テストケース | 条件 | 期待結果 |
|----|--------------|------|----------|
| AF-012 | ユーザー名取得 | ログイン済み | displayName返却 |
| AF-013 | メールアドレス取得 | ログイン済み | email返却 |
| AF-014 | UID取得 | ログイン済み | uid返却 |
| AF-015 | ロール取得 | Firestoreからロール取得 | role返却 |

#### 2.2.6 管理者権限テスト
| No | テストケース | ユーザー | 期待結果 |
|----|--------------|----------|----------|
| AF-016 | 管理者判定（true） | role=admin | isAdmin=true |
| AF-017 | 管理者判定（false） | role=employee | isAdmin=false |

### 2.3 モック要件
- Firebase Auth のモック（signInWithEmailAndPassword, signOut, onAuthStateChanged）
- Firestore のモック（ユーザードキュメント取得）

### 2.4 作成ファイル
```
tests/unit/stores/authFirebase.spec.ts
```

---

## 3. attendanceFirebase.ts テスト実装

### 3.1 概要
勤怠データのCRUD操作を行うストアテスト。打刻機能の中核。

### 3.2 テストケース

#### 3.2.1 初期化テスト
| No | テストケース | 期待結果 |
|----|--------------|----------|
| ATF-001 | 初期状態確認 | attendances=[], todayAttendance=null |
| ATF-002 | ローディング状態 | loading=false |

#### 3.2.2 出勤打刻テスト
| No | テストケース | 入力 | 期待結果 |
|----|--------------|------|----------|
| ATF-003 | 出勤打刻成功 | userId, 位置情報 | 新規ドキュメント作成 |
| ATF-004 | 出勤時刻記録 | - | checkIn に現在時刻 |
| ATF-005 | 位置情報記録 | 緯度,経度,精度 | checkInLocation に保存 |
| ATF-006 | ステータス設定 | 9:00前出勤 | status=present |
| ATF-007 | 遅刻判定 | 9:00以降出勤 | status=late |

#### 3.2.3 退勤打刻テスト
| No | テストケース | 前提条件 | 期待結果 |
|----|--------------|----------|----------|
| ATF-008 | 退勤打刻成功 | 出勤済み | checkOut追加 |
| ATF-009 | 勤務時間計算 | 退勤時 | workingMinutes計算 |
| ATF-010 | 早退判定 | 18:00前退勤 | status=early_leave |
| ATF-011 | 退勤位置情報 | - | checkOutLocation保存 |

#### 3.2.4 データ取得テスト
| No | テストケース | クエリ | 期待結果 |
|----|--------------|--------|----------|
| ATF-012 | 本日の勤怠取得 | userId, 今日の日付 | 該当レコード返却 |
| ATF-013 | 月次勤怠取得 | userId, 年月 | 当月のレコード一覧 |
| ATF-014 | 存在しない勤怠 | 該当なし | null返却 |
| ATF-015 | 全勤怠取得（管理者） | - | 全ユーザーのレコード |

#### 3.2.5 データ更新テスト
| No | テストケース | 操作 | 期待結果 |
|----|--------------|------|----------|
| ATF-016 | 勤怠編集 | 時刻修正 | ドキュメント更新 |
| ATF-017 | ステータス変更 | status変更 | 更新反映 |

#### 3.2.6 エラーハンドリング
| No | テストケース | 条件 | 期待結果 |
|----|--------------|------|----------|
| ATF-018 | Firestore接続エラー | ネットワーク切断 | エラーハンドリング |
| ATF-019 | 権限エラー | 他ユーザーデータ編集 | エラー返却 |
| ATF-020 | バリデーションエラー | 不正なデータ | エラー返却 |

#### 3.2.7 リアルタイム更新テスト
| No | テストケース | イベント | 期待結果 |
|----|--------------|----------|----------|
| ATF-021 | データ追加検知 | 新規打刻 | state更新 |
| ATF-022 | データ更新検知 | 編集 | state更新 |
| ATF-023 | サブスクリプション解除 | unmount | リスナー解除 |

### 3.3 モック要件
- Firestore のモック（collection, doc, addDoc, updateDoc, onSnapshot, query, where）
- Timestamp のモック

### 3.4 作成ファイル
```
tests/unit/stores/attendanceFirebase.spec.ts
```

---

## 4. DashboardView.vue テスト実装

### 4.1 概要
管理者ダッシュボードのUIテスト。グラフとサマリーの表示確認。

### 4.2 テストケース

#### 4.2.1 アクセス制御
| No | テストケース | ユーザー | 期待結果 |
|----|--------------|----------|----------|
| DV-001 | 管理者アクセス | role=admin | 画面表示 |
| DV-002 | 一般ユーザーリダイレクト | role=employee | ホームへリダイレクト |

#### 4.2.2 サマリーカード表示
| No | テストケース | データ | 期待結果 |
|----|--------------|--------|----------|
| DV-003 | 出勤率表示 | mockSummary | パーセンテージ表示 |
| DV-004 | 平均勤務時間表示 | mockSummary | 時間表示 |
| DV-005 | 遅刻者数表示 | mockSummary | 人数表示 |
| DV-006 | 早退者数表示 | mockSummary | 人数表示 |

#### 4.2.3 グラフ表示
| No | テストケース | グラフ種類 | 期待結果 |
|----|--------------|------------|----------|
| DV-007 | 月次出勤率グラフ | 折れ線 | ApexChart描画 |
| DV-008 | 部署別勤務時間グラフ | 棒 | ApexChart描画 |
| DV-009 | 遅刻・早退推移グラフ | 複数折れ線 | ApexChart描画 |
| DV-010 | 当日出勤状況グラフ | ドーナツ | ApexChart描画 |

#### 4.2.4 データ読み込み
| No | テストケース | 状態 | 期待結果 |
|----|--------------|------|----------|
| DV-011 | ローディング表示 | データ取得中 | スピナー表示 |
| DV-012 | データ取得成功 | 取得完了 | グラフ・サマリー表示 |
| DV-013 | データ取得失敗 | エラー | エラーメッセージ表示 |

### 4.3 モック要件
- `useAdminAttendanceStore` のモック
- `useAuthFirebaseStore` のモック
- ApexCharts のモック（または実際にレンダリング）

### 4.4 作成ファイル
```
tests/unit/views/admin/DashboardView.spec.ts
```

---

## 実装順序

1. **authFirebase.ts** - 他のテストの前提となる認証ストア
2. **attendanceFirebase.ts** - 打刻機能の中核ストア
3. **HomeView.vue** - ストアを使用するUIテスト
4. **DashboardView.vue** - 管理者向けUIテスト

---

## GitHub Issues

以下のIssueを作成する:

1. **#17** - [Phase1] authFirebase.ts 単体テスト実装
2. **#18** - [Phase1] attendanceFirebase.ts 単体テスト実装
3. **#19** - [Phase1] HomeView.vue 単体テスト実装
4. **#20** - [Phase1] DashboardView.vue 単体テスト実装

---

## 完了条件

- [ ] 全テストケースが実装されている
- [ ] 全テストがパス（緑）している
- [ ] カバレッジが向上している
  - コンポーネント: 25% → 40%以上
  - ストア: 17% → 50%以上
- [ ] ドキュメントが更新されている
