# `HomeView.vue` 単体テスト仕様書

## 1. 概要

| 項目 | 内容 |
|:---|:---|
| 対象ファイル | `src/views/HomeView.vue` |
| 関連設計書 | [基本設計書 1.3.1](../../design/03-basic/03-basic-design.md#131-打刻画面-homeviewvue) |
| 設計書記載 | 打刻画面（リアルタイム時刻表示、出退勤打刻、位置情報取得） |

## 2. テストの目的

`HomeView.vue`コンポーネントが、現在時刻の表示、出退勤打刻機能、位置情報取得、勤務状態の表示を正しく実装していることを保証する。

## 3. 使用するライブラリ

* **テストランナー**: Vitest
* **コンポーネントテスト**: Vue Test Utils
* **状態管理**: Pinia (テスト用にモック化)
* **モック**: vi.useFakeTimers (時刻操作)、navigator.geolocation (位置情報モック)

## 4. テストケース

### 4.1. 初期表示・時刻表示

| テストNo. | テストケース | 期待する結果 |
| :--- | :--- | :--- |
| 1-1 | 時刻表示 | 現在時刻が`HH:mm:ss`形式で表示される。 |
| 1-2 | 日付表示 | 現在日付が「YYYY年MM月DD日 曜日」形式で表示される。 |
| 1-3 | 時刻自動更新 | 1秒ごとに時刻表示が更新される。 |
| 1-4 | 初期打刻状態読み込み | マウント時に`loadAttendanceState`が実行され、今日の打刻状態が読み込まれる。 |

### 4.2. 出勤打刻 (`handleCheckIn`)

| テストNo. | テストケース | 条件 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 2-1 | 出勤打刻成功 | ユーザーログイン済み、位置情報取得成功 | ・`attendanceStore.clockIn`が呼び出される。<br>・成功スナックバーが表示される。<br>・`checkInTime`が設定される。<br>・`checkInLocation`が表示される。 |
| 2-2 | 出勤打刻成功（位置情報失敗） | 位置情報取得失敗 | ・警告スナックバーが表示される。<br>・デフォルト位置(0,0,0)で打刻される。 |
| 2-3 | 出勤打刻失敗 | ストアがエラーを返す | ・エラースナックバーが表示される。<br>・`checkInTime`が設定されない。 |
| 2-4 | ユーザー未ログイン | `authStore.user`がnull | ・エラースナックバー「ユーザー情報が取得できません」が表示される。<br>・打刻処理が実行されない。 |
| 2-5 | 出勤済みの場合 | `checkInTime`が既に設定済み | 出勤打刻ボタンが非活性化される。 |

### 4.3. 退勤打刻 (`handleCheckOut`)

| テストNo. | テストケース | 条件 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 3-1 | 退勤打刻成功 | 出勤済み、未退勤 | ・`attendanceStore.clockOut`が呼び出される。<br>・成功スナックバーが表示される。<br>・`checkOutTime`が設定される。 |
| 3-2 | 退勤打刻失敗 | ストアがエラーを返す | ・エラースナックバーが表示される。 |
| 3-3 | 未出勤の場合 | `checkInTime`がnull | 退勤打刻ボタンが非活性化される。 |
| 3-4 | 退勤済みの場合 | `checkOutTime`が既に設定済み | 退勤打刻ボタンが非活性化される。 |

### 4.4. 勤務状態表示 (`currentStatus` computed)

| テストNo. | テストケース | 条件 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 4-1 | 未出勤 | `checkInTime`がnull | ステータス表示なし（`-`） |
| 4-2 | 正常出勤 | 9:00以前に出勤 | ステータスが「正常」（緑）で表示される。 |
| 4-3 | 遅刻 | 9:00以降に出勤 | ステータスが「遅刻」（警告色）で表示される。 |
| 4-4 | 早退 | 18:00前に退勤（遅刻でない場合） | ステータスが「早退」（情報色）で表示される。 |

### 4.5. 勤務時間計算 (`workingHours` computed)

| テストNo. | テストケース | 条件 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 5-1 | 未出勤 | `checkInTime`がnull | `'-'`が表示される。 |
| 5-2 | 勤務中 | 出勤済み、未退勤 | 出勤時刻から現在時刻までの時間が`H:MM`形式で表示される。 |
| 5-3 | 退勤済み | 出勤済み、退勤済み | 出勤時刻から退勤時刻までの時間が表示される。 |

### 4.6. 位置情報取得 (`getCurrentLocation`)

| テストNo. | テストケース | 条件 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 6-1 | 位置情報取得成功 | `navigator.geolocation`が成功 | `Location`オブジェクトが返される。 |
| 6-2 | 位置情報未サポート | `navigator.geolocation`がundefined | エラーがrejectされる。 |
| 6-3 | 権限拒否 | `PERMISSION_DENIED`エラー | 「位置情報の許可が拒否されました」がrejectされる。 |
| 6-4 | 位置情報利用不可 | `POSITION_UNAVAILABLE`エラー | 「位置情報が利用できません」がrejectされる。 |
| 6-5 | タイムアウト | `TIMEOUT`エラー | 「位置情報の取得がタイムアウトしました」がrejectされる。 |

### 4.7. 住所変換 (`getAddressFromCoords`)

| テストNo. | テストケース | 条件 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 7-1 | 住所取得成功 | Nominatim APIが正常応答 | 都道府県、市区町村等を含む住所文字列が返される。 |
| 7-2 | 住所取得失敗 | APIエラー | `'住所不明'`が返される。 |

### 4.8. ライフサイクル

| テストNo. | テストケース | イベント | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 8-1 | マウント時 | `onMounted` | ・`loadAttendanceState`が実行される。<br>・`updateTime`が実行される。<br>・1秒間隔でタイマーがセットされる。 |
| 8-2 | アンマウント時 | `onUnmounted` | タイマーがクリアされる。 |

### 4.9. ローディング状態

| テストNo. | テストケース | 条件 | 期待する結果 |
| :--- | :--- | :--- | :--- |
| 9-1 | ローディング表示 | `loading`がtrue | オーバーレイとプログレスサークルが表示される。 |
| 9-2 | ボタン非活性化 | `loading`がtrue | 出勤・退勤ボタンが非活性化される。 |
